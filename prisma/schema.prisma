generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// WORKSPACES (Multi-tenancy)
// ============================================

model Workspace {
  id        String   @id @default(cuid())
  name      String
  slug      String   // Unique constraint handled via partial indexes in migration
  logoUrl   String?  @map("logo_url")
  cnpj      String?  // CNPJ for subworkspaces
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Subworkspace hierarchy
  parentWorkspaceId  String?    @map("parent_workspace_id")
  parentWorkspace    Workspace? @relation("WorkspaceHierarchy", fields: [parentWorkspaceId], references: [id])
  subworkspaces      Workspace[] @relation("WorkspaceHierarchy")
  hasSubworkspaces   Boolean    @default(false) @map("has_subworkspaces")

  // API Integration Tokens (only set by SuperAdmin on parent workspaces)
  carApiKey                String?  @map("car_api_key")           // CAR API Key
  carCooperativeId         String?  @map("car_cooperative_id")    // Cooperative ID for CAR API
  esgApiEnabled            Boolean  @default(false) @map("esg_api_enabled")  // Is ESG/CAR analysis enabled for this workspace
  esgEnabledForSubworkspaces Boolean @default(false) @map("esg_enabled_for_subworkspaces") // Allow subworkspaces to use parent's token

  // AI Document Validation settings
  aiDocValidationEnabled           Boolean @default(false) @map("ai_doc_validation_enabled")
  aiDocValidationEnabledForSubs    Boolean @default(false) @map("ai_doc_validation_enabled_for_subs")
  aiDocValidationMode              String  @default("warn") @map("ai_doc_validation_mode") // "warn" | "block"

  users               User[]
  producers           Producer[]
  templates           Template[]
  checklists          Checklist[]
  auditLogs           AuditLog[]
  aiPrompts           AiPrompt[]
  templateAssignments TemplateAssignment[]

  @@index([parentWorkspaceId])
  @@index([slug])
  @@map("workspaces")
}

// ============================================
// USERS & AUTH
// ============================================

enum UserRole {
  SUPERADMIN  // Global admin - manages workspaces and global users
  ADMIN       // Workspace admin - full access within workspace
  SUPERVISOR  // Can manage assigned producers
  PRODUCER    // Producer access only
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  name               String?
  passwordHash       String    @map("password_hash")
  mustChangePassword Boolean   @default(true) @map("must_change_password")
  cpf                String?
  role               UserRole  @default(SUPERVISOR)
  workspaceId        String?   @map("workspace_id")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  workspace            Workspace? @relation(fields: [workspaceId], references: [id])
  templatesCreated     Template[]
  checklistsCreated    Checklist[]
  auditLogs            AuditLog[]
  internalResponses    Response[] @relation("InternalResponses")
  assignedProducers    Producer[] @relation("SupervisorProducers")
  templateAssignments  TemplateAssignment[]
  
  @@unique([cpf, workspaceId]) // CPF unique within workspace
  @@index([workspaceId])
  @@map("users")
}

// ============================================
// PRODUCERS
// ============================================

model Producer {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  name        String
  countryCode String   @default("BR")
  subjectType String   @default("person") // person | org
  
  // Legacy BR fields (kept for backward compatibility)
  cpf         String?  // Unique per workspace (constraint via index)
  email       String?
  phone       String?
  city        String?
  state       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace            Workspace @relation(fields: [workspaceId], references: [id])
  subUsers             SubUser[]
  checklists           Checklist[]
  maps                 PropertyMap[]
  assignedSupervisors  User[]        @relation("SupervisorProducers")
  
  // ESG (Brazil-specific)
  esgStatus    String?
  esgData      Json?
  esgLastCheck DateTime?

  // International support
  identifiers          ProducerIdentifier[]
  agriculturalRegistry AgriculturalRegistry?

  @@unique([cpf, workspaceId]) // CPF unique within workspace (allows same producer in parent + subworkspace)

  @@index([workspaceId])
  @@index([cpf])
  @@index([email])
  @@index([countryCode])
  @@map("producers")
}

// Flexible identifier storage for international producers
model ProducerIdentifier {
  id         String   @id @default(cuid())
  producerId String
  category   String   // personal | fiscal
  idType     String   // cpf, dni, ssn, cnpj, cuit, ein
  idValue    String
  createdAt  DateTime @default(now())

  producer   Producer @relation(fields: [producerId], references: [id], onDelete: Cascade)

  @@unique([producerId, category])
  @@index([idType, idValue])
  @@map("producer_identifiers")
}

// Agricultural registry for international producers
model AgriculturalRegistry {
  id            String   @id @default(cuid())
  producerId    String   @unique
  registryType  String   // car, renspa, fsa
  registryValue String
  countryCode   String
  createdAt     DateTime @default(now())

  producer      Producer @relation(fields: [producerId], references: [id], onDelete: Cascade)

  @@map("agricultural_registries")
}

model SubUser {
  id         String   @id @default(cuid())
  producerId String
  name       String
  cpf        String
  email      String
  phone      String?
  role       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  producer   Producer @relation(fields: [producerId], references: [id], onDelete: Cascade)
  checklists Checklist[]
  
  @@index([producerId])
  @@map("sub_users")
}

// ============================================
// TEMPLATES
// ============================================

enum TemplateStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Template {
  id                              String         @id @default(cuid())
  workspaceId                     String         @map("workspace_id")
  name                            String
  folder                          String
  status                          TemplateStatus @default(ACTIVE)
  requiresProducerIdentification  Boolean        @default(false)
  isContinuous                    Boolean        @default(false)
  actionPlanPromptId              String?
  correctionActionPlanPromptId    String?  // Prompt para filhos tipo CORRECTION
  completionActionPlanPromptId    String?  // Prompt para filhos tipo COMPLETION
  createdById                     String
  createdAt                       DateTime       @default(now())
  updatedAt                       DateTime       @updatedAt

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  createdBy  User       @relation(fields: [createdById], references: [id])
  sections   Section[]
  checklists Checklist[]
  assignments TemplateAssignment[]
  
  @@index([workspaceId])
  @@index([status])
  @@index([createdById])
  @@map("templates")
}

// Template assignment to subworkspaces (many-to-many)
model TemplateAssignment {
  id            String   @id @default(cuid())
  templateId    String   @map("template_id")
  workspaceId   String   @map("workspace_id") // The subworkspace receiving the template
  assignedAt    DateTime @default(now()) @map("assigned_at")
  assignedById  String   @map("assigned_by_id")

  template    Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignedBy  User      @relation(fields: [assignedById], references: [id])

  @@unique([templateId, workspaceId])
  @@index([templateId])
  @@index([workspaceId])
  @@map("template_assignments")
}

model Section {
  id                String  @id @default(cuid())
  templateId        String
  name              String
  order             Int
  iterateOverFields Boolean @default(false)

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  items    Item[]
  
  @@index([templateId])
  @@map("sections")
}

enum ItemType {
  FILE
  TEXT
  LONG_TEXT
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  DATE
  PROPERTY_MAP
  FIELD_SELECTOR
  DROPDOWN_SELECT
}

model Item {
  id                 String   @id @default(cuid())
  sectionId          String
  name               String
  type               ItemType
  order              Int
  required           Boolean  @default(true)
  validityControl    Boolean  @default(false)
  observationEnabled Boolean  @default(false)
  requestArtifact    Boolean  @default(false)
  artifactRequired   Boolean  @default(false)
  askForQuantity     Boolean  @default(false)
  options            String[]
  databaseSource     String?
  
  section   Section    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  responses Response[]
  
  @@index([sectionId])
  @@map("items")
}

// ============================================
// CHECKLISTS (Instâncias)
// ============================================

enum ChecklistStatus {
  DRAFT
  SENT
  IN_PROGRESS
  PENDING_REVIEW
  APPROVED
  REJECTED
  PARTIALLY_FINALIZED
  FINALIZED
}

enum ChecklistType {
  ORIGINAL
  CORRECTION
  COMPLETION
}

model Checklist {
  id          String          @id @default(cuid())
  workspaceId String          @map("workspace_id")
  templateId  String
  producerId  String?
  subUserId   String?
  status      ChecklistStatus @default(DRAFT)
  type        ChecklistType   @default(ORIGINAL)
  publicToken String          @unique
  sentAt      DateTime?
  submittedAt DateTime?
  reviewedAt  DateTime?
  finalizedAt DateTime?
  createdById String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  sentVia     String?
  sentTo      String?
  
  parentId    String?
  parent      Checklist?  @relation("ChecklistHistory", fields: [parentId], references: [id])
  children    Checklist[] @relation("ChecklistHistory")

  workspace  Workspace   @relation(fields: [workspaceId], references: [id])
  template   Template    @relation(fields: [templateId], references: [id])
  producer   Producer?   @relation(fields: [producerId], references: [id])
  subUser    SubUser?    @relation(fields: [subUserId], references: [id])
  createdBy  User        @relation(fields: [createdById], references: [id])
  responses  Response[]
  auditLogs  AuditLog[]
  reports    Report[]
  actionPlans ActionPlan[]
  
  @@index([workspaceId])
  @@index([publicToken])
  @@index([producerId])
  @@index([status])
  @@map("checklists")
}

// ============================================
// RESPONSES
// ============================================

enum ResponseStatus {
  MISSING
  PENDING_VERIFICATION
  APPROVED
  REJECTED
}

model Response {
  id              String         @id @default(cuid())
  checklistId     String
  itemId          String
  status          ResponseStatus @default(MISSING)
  answer          String?
  quantity        String?
  observation     String?
  fileUrl         String?
  validity        DateTime?
  rejectionReason String?
  reviewedAt      DateTime?
  aiFlag          String?
  aiMessage       String?
  aiConfidence    Float?
  isInternal      Boolean        @default(false)
  filledById      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  fieldId         String         @default("__global__") // ID do talhão ou "__global__" para geral

  checklist Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [id])
  filledBy  User?     @relation("InternalResponses", fields: [filledById], references: [id])

  @@unique([checklistId, itemId, fieldId], name: "checklistId_itemId_fieldId")
  @@index([checklistId])
  @@map("responses")
}

// ============================================
// ACTION PLANS & REPORTS
// ============================================

model ActionPlan {
  id          String   @id @default(cuid())
  checklistId String
  title       String
  description String   @db.Text
  summary     String?  @db.Text
  status      String   @default("OPEN")
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  items       ActionItem[]

  @@map("action_plans")
}

model ActionItem {
  id           String    @id @default(cuid())
  actionPlanId String
  itemRef      String?   // Referência ao item rejeitado (opcional)
  priority     String    @default("MEDIA") // ALTA, MEDIA, BAIXA
  action       String    @db.Text
  deadline     Int?      // Prazo em dias
  documents    String[]  // Documentos necessários
  responsible  String?   // Quem deve executar
  isCompleted  Boolean   @default(false)
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  actionPlan ActionPlan @relation(fields: [actionPlanId], references: [id], onDelete: Cascade)

  @@index([actionPlanId])
  @@map("action_items")
}

model Report {
  id          String   @id @default(cuid())
  checklistId String
  content     Json
  url         String?
  createdAt   DateTime @default(now())

  checklist   Checklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@map("reports")
}

// ============================================
// MAPAS GEOESPACIAIS
// ============================================

model PropertyMap {
  id               String   @id @default(cuid())
  producerId       String
  name             String?
  countryCode      String   @default("BR")
  sourceType       String   @default("car") // car | upload | draw
  propertyLocation Json?
  carCode          String?
  carData          Json?
  carEsgStatus     String?
  carEsgData       Json?
  carEsgLastCheck  DateTime?
  fields           Json
  city             String?
  state            String?
  emeCode          String?
  ruralRegionCode  Int?
  areaHa           Float?
  uploadedFileUrl  String?
  uploadedFileType String?  // kml | geojson
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  producer Producer @relation(fields: [producerId], references: [id], onDelete: Cascade)
  
  @@index([producerId])
  @@index([countryCode])
  @@map("property_maps")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  workspaceId String?  @map("workspace_id")
  checklistId String?
  userId      String
  action      String
  details     Json?
  createdAt   DateTime @default(now())
  
  workspace Workspace? @relation(fields: [workspaceId], references: [id])
  checklist Checklist? @relation(fields: [checklistId], references: [id], onDelete: SetNull)
  user      User       @relation(fields: [userId], references: [id])
  
  @@index([workspaceId])
  @@index([checklistId])
  @@index([userId])
  @@map("audit_logs")
}

// ============================================
// CONFIGURAÇÃO IA
// ============================================

model AiPrompt {
  id          String    @id @default(cuid())
  workspaceId String?   @map("workspace_id") // null = global/default prompt
  slug        String
  description String?
  template    String    @db.Text
  model       String    @default("gpt-4o")
  temperature Float     @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, slug]) // Unique per workspace (or global if workspaceId is null)
  @@index([workspaceId])
  @@map("ai_prompts")
}

model DatabaseOption {
  id          String   @id @default(cuid())
  source      String
  label       String
  value       String
  composition String?
  unit        String?
  createdAt   DateTime @default(now())

  @@index([source])
  @@map("database_options")
}

model SystemConfig {
  key   String @id
  value String

  @@map("system_config")
}

// ============================================
// RURAL REGIONS (Municípios e Regiões Rurais)
// ============================================

model RuralRegion {
  id           String @id @default(cuid())
  munCode      String @unique
  municipality String
  stateCode    String
  stateShort   String
  rrCode       Int

  @@index([stateShort])
  @@index([rrCode])
  @@map("rural_regions")
}

// ============================================
// EME (Órgãos Estaduais de Meio Ambiente)
// ============================================

model EME {
  id     String @id @default(cuid())
  uf     String @unique
  codigo Int
  eme    String

  @@map("eme")
}
